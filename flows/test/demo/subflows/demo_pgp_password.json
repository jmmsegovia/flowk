{
  "id": "subflows.demo_pgp_password",
  "description": "Demonstration of symmetric PGP encryption/decryption using MusicBrainz data without shell commands.",
  "tasks": [
    {
      "id": "pgp.vars",
      "description": "Declare PGP demo variables",
      "action": "VARIABLES",
      "scope": "flow",
      "overwrite": true,
      "vars": [
        {
          "name": "pgp_password",
          "type": "string",
          "value": "VerySecurePassword!"
        },
        {
          "name": "pgp_profile_message",
          "type": "string",
          "value": "Artist: ${demo_musicbrainz_artist}\nCountry: ${demo_musicbrainz_country}\nBegin year: ${demo_musicbrainz_begin_year}\nBegin area: ${demo_musicbrainz_begin_area}"
        },
        {
          "name": "pgp_summary_message",
          "type": "string",
          "value": "${demo_musicbrainz_summary}"
        }
      ]
    },
    {
      "id": "pgp.encrypt",
      "description": "Encrypt the MusicBrainz messages using the PGP action",
      "action": "PGP",
      "steps": [
        {
          "id": "encrypt_profile",
          "operation": "ENCRYPT",
          "password": "${pgp_password}",
          "message": "${pgp_profile_message}",
          "armor": true,
          "fileName": "artist_profile.txt"
        },
        {
          "id": "encrypt_summary",
          "operation": "ENCRYPT",
          "password": "${pgp_password}",
          "message": "${pgp_summary_message}",
          "armor": true,
          "fileName": "artist_summary.txt"
        }
      ]
    },
    {
      "id": "pgp.capture_ciphertext",
      "description": "Capture encrypted payloads for the decrypt step",
      "action": "VARIABLES",
      "scope": "flow",
      "vars": [
        {
          "name": "pgp_profile_ciphertext",
          "type": "string",
          "value": "${from.task:pgp.encrypt.result$.steps[0].result.ciphertext.value}"
        },
        {
          "name": "pgp_summary_ciphertext",
          "type": "string",
          "value": "${from.task:pgp.encrypt.result$.steps[1].result.ciphertext.value}"
        }
      ]
    },
    {
      "id": "pgp.decrypt",
      "description": "Decrypt the encrypted payloads using the PGP action",
      "action": "PGP",
      "steps": [
        {
          "id": "decrypt_profile",
          "operation": "DECRYPT",
          "message": "${pgp_profile_ciphertext}",
          "passwords": [
            "${pgp_password}"
          ],
          "outputEncoding": "utf8"
        },
        {
          "id": "decrypt_summary",
          "operation": "DECRYPT",
          "message": "${pgp_summary_ciphertext}",
          "passwords": [
            "${pgp_password}"
          ],
          "outputEncoding": "utf8"
        }
      ]
    },
    {
      "id": "pgp.verify_content",
      "description": "Verify that the decrypted messages match the originals",
      "action": "EVALUATE",
      "if_conditions": [
        {
          "left": "${from.task:pgp.decrypt.result$.steps[0].result.plaintext.value}",
          "operation": "=",
          "right": "${pgp_profile_message}"
        },
        {
          "left": "${from.task:pgp.decrypt.result$.steps[1].result.plaintext.value}",
          "operation": "=",
          "right": "${pgp_summary_message}"
        }
      ],
      "then": {
        "continue": "PGP decrypt output matches the original messages"
      },
      "else": {
        "exit": "PGP decrypt output does not match the original messages"
      }
    },
    {
      "id": "vars.pgp_summary",
      "description": "Capture the PGP demo artifacts for downstream reporting",
      "action": "VARIABLES",
      "scope": "flow",
      "vars": [
        {
          "name": "demo_pgp_demo_dir",
          "type": "string",
          "value": "in-memory"
        },
        {
          "name": "demo_pgp_status",
          "type": "string",
          "value": "verified"
        },
        {
          "name": "demo_pgp_encrypted_files",
          "type": "array",
          "value": [
            "${pgp_profile_ciphertext}",
            "${pgp_summary_ciphertext}"
          ]
        }
      ]
    },
    {
      "id": "print.pgp_summary",
      "description": "Print the PGP demo status and output locations",
      "action": "PRINT",
      "entries": [
        {
          "message": "PGP demo status",
          "variable": "demo_pgp_status"
        },
        {
          "message": "PGP demo storage",
          "variable": "demo_pgp_demo_dir"
        },
        {
          "message": "PGP encrypted payloads",
          "variable": "demo_pgp_encrypted_files"
        }
      ]
    }
  ]
}
