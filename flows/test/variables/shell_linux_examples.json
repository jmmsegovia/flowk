{
  "id": "shell_linux_examples",
  "description": "Demonstrations of the SHELL action in Linux exporting variables and reusing them within each script. Works in Linux and WSL environments.",
  "tasks": [
    {
      "id": "vars.define_context",
      "description": "Defines base variables used by the shell commands",
      "action": "VARIABLES",
      "scope": "flow",
      "overwrite": true,
      "vars": [
        {
          "name": "demo_root",
          "type": "string",
          "value": "./tmp/flowk_shell_demo"
        },
        {
          "name": "release_name",
          "type": "string",
          "value": "2024.10-lts"
        }
      ]
    },
    {
      "id": "shell.create_structure",
      "description": "Creates a working directory tree by exporting variables and using them immediately",
      "action": "SHELL",
      "command": [
        "set -euo pipefail",
        "export DEMO_ROOT=\"${demo_root}\"",
        "export BIN_DIR=\"$DEMO_ROOT/bin\"",
        "export CACHE_DIR=\"$DEMO_ROOT/cache\"",
        "mkdir -p \"$BIN_DIR\" \"$CACHE_DIR\"",
        "echo \"Root directory: $DEMO_ROOT\" >&2",
        "echo \"Binaries: $BIN_DIR\" >&2",
        "echo \"Cache: $CACHE_DIR\" >&2",
        "export LOG_FILE=\"$DEMO_ROOT/operations.log\"",
        "cat <<INFO > \"$LOG_FILE\"",
        "DEMO_ROOT=$DEMO_ROOT",
        "BIN_DIR=$BIN_DIR",
        "CACHE_DIR=$CACHE_DIR",
        "INFO",
        "printf '%s' \"$LOG_FILE\""
      ],
      "shell": {
        "program": "/bin/bash",
        "args": [
          "-lc"
        ]
      }
    },
    {
      "id": "vars.register_log",
      "description": "Saves the path of the log generated by the previous command",
      "action": "VARIABLES",
      "scope": "flow",
      "overwrite": true,
      "vars": [
        {
          "name": "log_file_path",
          "type": "string",
          "value": "${from.task:shell.create_structure.result$.stdout}"
        }
      ]
    },
    {
      "id": "shell.write_metadata",
      "description": "Exports additional variables, computes a timestamp, and reuses it to complete the log",
      "action": "SHELL",
      "command": [
        "set -euo pipefail",
        "export LOG_FILE_PATH=\"${log_file_path}\"",
        "export TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)",
        "echo \"Release: $RELEASE_NAME\" >> \"$LOG_FILE_PATH\"",
        "echo \"Timestamp: $TIMESTAMP\" >> \"$LOG_FILE_PATH\"",
        "printf '%s' \"$TIMESTAMP\""
      ],
      "shell": {
        "program": "/bin/bash",
        "args": [
          "-lc"
        ]
      },
      "environment": [
        {
          "name": "RELEASE_NAME",
          "value": "${release_name}"
        }
      ]
    },
    {
      "id": "vars.timestamp",
      "description": "Keeps the generated timestamp to reuse it later",
      "action": "VARIABLES",
      "scope": "flow",
      "overwrite": true,
      "vars": [
        {
          "name": "last_timestamp",
          "type": "string",
          "value": "${from.task:shell.write_metadata.result$.stdout}"
        }
      ]
    },
    {
      "id": "shell.final_summary",
      "description": "Generates a summary file reusing exported and flow-stored variables",
      "action": "SHELL",
      "command": [
        "set -euo pipefail",
        "export LOG_FILE_PATH=\"${log_file_path}\"",
        "export LAST_TIMESTAMP=\"${last_timestamp}\"",
        "export SUMMARY_FILE=\"$LOG_FILE_PATH.summary\"",
        "export LINE_COUNT=$(wc -l < \"$LOG_FILE_PATH\")",
        "cat <<SUMMARY > \"$SUMMARY_FILE\"",
        "Summary generated: $LAST_TIMESTAMP",
        "Log entries: $LINE_COUNT",
        "Log location: $LOG_FILE_PATH",
        "Note: $EXTRA_NOTE",
        "SUMMARY",
        "cat \"$SUMMARY_FILE\"",
        "printf '%s' \"$SUMMARY_FILE\""
      ],
      "shell": {
        "program": "/bin/bash",
        "args": [
          "-lc"
        ]
      },
      "environment": [
        {
          "name": "EXTRA_NOTE",
          "value": "SHELL command validation"
        }
      ]
    }
  ]
}
